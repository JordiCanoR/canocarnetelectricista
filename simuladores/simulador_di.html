// üü¢ Simulador Derivaci√≥n Individual - Pro (versi√≥n profesional REBT COMPLETA + ca√≠da tensi√≥n + formulario web)

const tablasOficiales = {
    aire: {...},
    enterrado: {...}
};

const factoresTemperatura = {
    25: 1.12, 30: 1.00, 35: 0.94, 40: 0.88, 45: 0.82, 50: 0.76
};

const factoresAgrupamiento = {
    1: 1.00, 2: 0.80, 3: 0.70, 4: 0.65, 5: 0.60
};

const porcentajeCaida = {
    total: 1.00,
    parcial: 0.50,
    sinLGA: 1.50
};

function calcularDerivacionIndividual({potencia, tension, tipoSuministro, cosphi, tipoInstalacion, seccion, material, temperatura=30, numeroCircuitos=1, centralizacion='total', longitud=0}) {
    const P = potencia * 1000;
    let I = (tipoSuministro === 'mono') ? P / (tension * cosphi) : P / (Math.sqrt(3) * tension * cosphi);

    const tablaTipo = ['D1','D2'].includes(tipoInstalacion) ? 'enterrado' : 'aire';
    const tabla = tablasOficiales[tablaTipo][material][tipoInstalacion];
    const IadmBase = tabla ? tabla[seccion] : undefined;

    if (!IadmBase) return {error: 'Datos no v√°lidos'};

    const factorTemp = factoresTemperatura[temperatura] ?? 1.00;
    const factorAgrup = factoresAgrupamiento[numeroCircuitos] ?? 0.60;
    const IadmCorregido = IadmBase * factorTemp * factorAgrup;

    // ‚ûï C√°lculo secci√≥n m√≠nima normativa
    let seccionMinima = null;
    if (tabla) {
        const seccionesOrdenadas = Object.keys(tabla).map(Number).sort((a, b) => a - b);
        for (const s of seccionesOrdenadas) {
            const intensidadBase = tabla[s];
            const intensidadCorregida = intensidadBase * factorTemp * factorAgrup;
            if (I <= intensidadCorregida) {
                seccionMinima = s;
                break;
            }
        }
    }

    const caidaMaxAdmisible = (porcentajeCaida[centralizacion] ?? 1.00) / 100 * tension;
    const resistenciaLineal = (material === 'cobre') ? 56 : 34;
    const caidaReal = (tipoSuministro === 'mono') ? (2 * longitud * I) / (resistenciaLineal * seccion) : (Math.sqrt(3) * longitud * I) / (resistenciaLineal * seccion);

    return {
        intensidadCalculada: I.toFixed(2),
        intensidadAdmisibleBase: IadmBase,
        intensidadAdmisibleCorregida: IadmCorregido.toFixed(2),
        seccion: seccion,
        temperatura: temperatura,
        numeroCircuitos: numeroCircuitos,
        centralizacion: centralizacion,
        longitud: longitud,
        caidaMaxAdmisible: caidaMaxAdmisible.toFixed(2),
        caidaReal: caidaReal.toFixed(2),
        cumpleIntensidad: I <= IadmCorregido,
        cumpleCaida: caidaReal <= caidaMaxAdmisible,
        seccionMinimaNormativa: seccionMinima
    };
}

// ‚û°Ô∏è FORMULARIO HTML EN P√ÅGINA

document.addEventListener('DOMContentLoaded', () => {
    document.body.innerHTML = `
<header><h1>Simulador Profesional de Derivaci√≥n Individual REBT</h1></header>
<style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1e1e2f; color: #f0f0f0; margin: 0; }
    header { background-color: #2a2a40; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 10; }
    header h1 { color: #4fc3f7; margin: 0; font-size: 24px; font-weight: 600; }
    .container { max-width: 800px; margin: 20px auto; background-color: #2a2a40; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    h2, h3 { text-align: center; color: #4fc3f7; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #555; background-color: #1e1e2f; color: #f0f0f0; }
    button { padding: 10px 20px; margin: 15px 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
    button.primary { background-color: #4fc3f7; color: #1e1e2f; }
    button.secondary { background-color: #555; color: #fff; }
    button:hover { filter: brightness(90%); }
    table { width: 100%; border-collapse: collapse; background-color: #2a2a40; margin-top: 20px; }
    table td, table th { border: 1px solid #555; padding: 8px; text-align: center; }
    table th { background-color: #4fc3f7; color: #1e1e2f; }
</style>
</style>
<div class='container'>
<h2>Simulador Derivaci√≥n Individual</h2>
        <input placeholder='Potencia kW' id='potencia'><br>
        <input placeholder='Tensi√≥n V' id='tension'><br>
        <input placeholder='CosœÜ (ej. 0.95)' id='cosphi'><br>
        <input placeholder='Secci√≥n mm¬≤' id='seccion'><br>
        <input placeholder='Temperatura (25-50)' id='temperatura'><br>
        <input placeholder='Longitud l√≠nea (m)' id='longitud'><br>
        <input placeholder='N¬∫ Circuitos' id='circuitos'><br>
        <input placeholder='Instalaci√≥n (A1,B2,D1...)' id='instalacion'><br>
        <input placeholder='Tipo de cable (2xPVC,3xPVC,2xXLPE,3xXLPE)' id='tipoCable'><br>
        <input placeholder='Material (cobre/aluminio)' id='material'><br>
        <input placeholder='Suministro (mono/tri)' id='suministro'><br>
        <input placeholder='Centralizaci√≥n (total/parcial/sinLGA)' id='centralizacion'><br>
        <button class='primary' onclick='calcular()'>Calcular</button>
<button class='secondary' onclick='reiniciar()'>Reiniciar</button>
        <pre id='resultado'></pre>`;
});

function reiniciar() {
    document.querySelectorAll('input').forEach(input => input.value = '');
    document.getElementById('resultado').innerHTML = '';
}

function calcular() {
    // Validaciones de entradas
    const campos = ['potencia', 'tension', 'cosphi', 'seccion', 'temperatura', 'longitud', 'circuitos'];
    for (let id of campos) {
        const valor = parseFloat(document.getElementById(id).value);
        if (isNaN(valor) || valor <= 0) {
            alert(`Por favor introduce un valor num√©rico v√°lido para ${id}`);
            return;
        }
    }

    const tipoSuministro = document.getElementById('suministro').value;
    if (tipoSuministro !== 'mono' && tipoSuministro !== 'tri') {
        alert('Tipo de suministro debe ser mono o tri');
        return;
    }

    const material = document.getElementById('material').value;
    if (material !== 'cobre' && material !== 'aluminio') {
        alert('Material debe ser cobre o aluminio');
        return;
    }
    const datos = {
        potencia: parseFloat(document.getElementById('potencia').value),
        tension: parseFloat(document.getElementById('tension').value),
        cosphi: parseFloat(document.getElementById('cosphi').value),
        seccion: parseFloat(document.getElementById('seccion').value),
        temperatura: parseInt(document.getElementById('temperatura').value),
        longitud: parseFloat(document.getElementById('longitud').value),
        numeroCircuitos: parseInt(document.getElementById('circuitos').value),
        tipoInstalacion: document.getElementById('instalacion').value,
        material: document.getElementById('material').value,
        tipoSuministro: document.getElementById('suministro').value,
        centralizacion: document.getElementById('centralizacion').value
    };

    datos.tipoCable = document.getElementById('tipoCable').value;
    const res = calcularDerivacionIndividual(datos);
    document.getElementById('resultado').innerHTML = `$1`;
    alert("‚úÖ C√°lculo realizado con √©xito.");
}
